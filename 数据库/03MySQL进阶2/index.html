<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
<meta name="referrer" content="no-referrer">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/icon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/icon.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yanglinqi107.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="源自黑马程序员，介绍了触发器、锁、InnoDB引擎、MySQL管理、数据的备份和恢复">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL进阶2">
<meta property="og:url" content="http://yanglinqi107.github.io/%E6%95%B0%E6%8D%AE%E5%BA%93/03MySQL%E8%BF%9B%E9%98%B62/index.html">
<meta property="og:site_name" content="杨记">
<meta property="og:description" content="源自黑马程序员，介绍了触发器、锁、InnoDB引擎、MySQL管理、数据的备份和恢复">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117130611111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117130711111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117130811111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117130911111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117131011111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117131211111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117131311111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117131411111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117131511111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117131611111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117131711111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117131811111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117131911111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117132011111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117132211111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117132311111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117132411111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117132511111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117132611111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117132711111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117132811111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117132911111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117133211111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117133311111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117133411111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117133511111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117133611111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117133711111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221109101611111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117133811111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117133911111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117173511111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117173611111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117173711111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117173811111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117173911111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117203911111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117204211111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117204311111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117204411111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117204511111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117204611111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117204711111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117204811111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118122311111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118140511111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118140611111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118140711111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118140811111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118140911111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118145011111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118145211111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118145311111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118145411111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118145511111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118145611111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118145711111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118145811111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118145911111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118150411111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118150511111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118150611111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118150711111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118150811111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118150911111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118151211111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118151311111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118151411111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118150911111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118151211111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118151511111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118151611111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118151711111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118151811111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118151911111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118181011111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118181211111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118181311111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118181411111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118181511111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118181611111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118181711111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118181811111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118181911111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118182011111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118182211111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118182311111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118182411111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118182511111.png">
<meta property="og:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118183311111.png">
<meta property="article:published_time" content="2022-11-27T09:39:15.347Z">
<meta property="article:modified_time" content="2023-02-19T10:19:45.767Z">
<meta property="article:author" content="yanglinqi">
<meta property="article:tag" content="MySQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117130611111.png">

<link rel="canonical" href="http://yanglinqi107.github.io/%E6%95%B0%E6%8D%AE%E5%BA%93/03MySQL%E8%BF%9B%E9%98%B62/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>MySQL进阶2 | 杨记</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">杨记</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">碎片化学习令人焦虑，系统化学习使人进步</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">24</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">18</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">98</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yanglinqi107.github.io/%E6%95%B0%E6%8D%AE%E5%BA%93/03MySQL%E8%BF%9B%E9%98%B62/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/headpic.jpg">
      <meta itemprop="name" content="yanglinqi">
      <meta itemprop="description" content="用于做笔记，对学过的知识总结">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MySQL进阶2
        </h1>

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-11-27 17:39:15" itemprop="dateCreated datePublished" datetime="2022-11-27T17:39:15+08:00">2022-11-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-19 18:19:45" itemprop="dateModified" datetime="2023-02-19T18:19:45+08:00">2023-02-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>源自黑马程序员，介绍了触发器、锁、InnoDB引擎、MySQL管理、数据的备份和恢复</p>
<span id="more"></span>
<h3 id="触发器"><a href="#触发器" class="headerlink" title="触发器"></a>触发器</h3><p>推荐链接：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/geaozhang/p/6819648.html">https://www.cnblogs.com/geaozhang/p/6819648.html</a></p>
<p>触发器是与表有关的数据库对象，指在insert/update/delete之前(BEFORE)或之后(AFTER)，触发并执行触发器中定义的SQL语句集合。触发器的这种特性可以协助应用在数据库端确保数据的完整性, 日志记录 , 数据校验等操作 。</p>
<p>使用别名OLD和NEW来引用触发器中发生变化的记录内容，这与其他的数据库是相似的。现在触发器还只支持<strong>行级触发</strong>，<strong>不支持语句级触发</strong>。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>触发器类型</th>
<th>NEW 和 OLD</th>
</tr>
</thead>
<tbody>
<tr>
<td>INSERT 型触发器</td>
<td>NEW 表示将要或者已经新增的数据</td>
</tr>
<tr>
<td>UPDATE 型触发器</td>
<td>OLD 表示修改之前的数据 , NEW 表示将要或已经修改后的数据</td>
</tr>
<tr>
<td>DELETE 型触发器</td>
<td>OLD 表示将要或者已经删除的数据</td>
</tr>
</tbody>
</table>
</div>
<p>1）创建触发器</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trigger_name</span><br><span class="line">BEFORE<span class="operator">/</span>AFTER <span class="keyword">INSERT</span><span class="operator">/</span>UPDATE<span class="operator">/</span><span class="keyword">DELETE</span></span><br><span class="line"><span class="keyword">ON</span> tbl_name <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="type">ROW</span> <span class="comment">-- 行级触发器 这个声明用来指定，对于受触发事件影响的每一行，都要激活触发器的动作</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    trigger_stmt ;</span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>
<p>2）查看触发器</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> TRIGGERS;	<span class="comment">-- 查看当前数据库所有触发器</span></span><br><span class="line"><span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> trigger_name;  <span class="comment">-- 查看trigger_name触发器</span></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.triggers <span class="keyword">where</span> trigger_name<span class="operator">=</span>触发器名称\G;</span><br></pre></td></tr></table></figure>
<p>3）删除触发器</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> [schema_name.]trigger_name ; <span class="comment">-- 如果没有指定 schema_name，默认为当前数据库 。</span></span><br></pre></td></tr></table></figure>
<p><strong>案例</strong></p>
<p>通过触发器记录 tb_user 表的数据变更日志，将变更日志插入到日志表user_logs中, 包含增加，修改 , 删除 ;</p>
<p>表结构准备:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 准备工作 : 日志表 user_logs</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user_logs(</span><br><span class="line">    id <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">not</span> <span class="keyword">null</span> auto_increment,</span><br><span class="line">    operation <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;操作类型, insert/update/delete&#x27;</span>,</span><br><span class="line">    operate_time datetime <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;操作时间&#x27;</span>,</span><br><span class="line">    operate_id <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;操作的ID&#x27;</span>,</span><br><span class="line">    operate_params <span class="type">varchar</span>(<span class="number">500</span>) comment <span class="string">&#x27;操作参数&#x27;</span>,</span><br><span class="line">	<span class="keyword">primary</span> key(`id`)</span><br><span class="line">)engine<span class="operator">=</span>innodb <span class="keyword">default</span> charset<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure>
<p>创建触发器：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 插入数据触发器</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">trigger</span> tb_user_insert_trigger</span><br><span class="line">after <span class="keyword">insert</span> <span class="keyword">on</span> tb_user <span class="keyword">for</span> <span class="keyword">each</span> <span class="type">row</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">	<span class="keyword">insert</span> <span class="keyword">into</span> user_logs(id, operation, operate_time, operate_id, operate_params) <span class="keyword">VALUES</span></span><br><span class="line">	(<span class="keyword">null</span>, <span class="string">&#x27;insert&#x27;</span>, now(), new.id, concat(<span class="string">&#x27;插入的数据内容为: id=&#x27;</span>,new.id,<span class="string">&#x27;,name=&#x27;</span>,new.name, <span class="string">&#x27;, phone=&#x27;</span>, NEW.phone, <span class="string">&#x27;, email=&#x27;</span>, NEW.email, <span class="string">&#x27;, profession=&#x27;</span>, NEW.profession));</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 修改数据触发器</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">trigger</span> tb_user_update_trigger</span><br><span class="line">after update <span class="keyword">on</span> tb_user <span class="keyword">for</span> <span class="keyword">each</span> <span class="type">row</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">insert</span> <span class="keyword">into</span> user_logs(id, operation, operate_time, operate_id, operate_params) <span class="keyword">VALUES</span></span><br><span class="line">    (<span class="keyword">null</span>, <span class="string">&#x27;update&#x27;</span>, now(), new.id, concat(<span class="string">&#x27;更新之前的数据: id=&#x27;</span>,old.id,<span class="string">&#x27;,name=&#x27;</span>,old.name, <span class="string">&#x27;, phone=&#x27;</span>, old.phone, <span class="string">&#x27;, email=&#x27;</span>, old.email, <span class="string">&#x27;, profession=&#x27;</span>, old.profession,</span><br><span class="line">    <span class="string">&#x27; | 更新之后的数据: id=&#x27;</span>,new.id,<span class="string">&#x27;,name=&#x27;</span>,new.name, <span class="string">&#x27;, phone=&#x27;</span>, NEW.phone, <span class="string">&#x27;, email=&#x27;</span>, NEW.email, <span class="string">&#x27;, profession=&#x27;</span>, NEW.profession));</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除数据触发器</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">trigger</span> tb_user_delete_trigger</span><br><span class="line">after <span class="keyword">delete</span> <span class="keyword">on</span> tb_user <span class="keyword">for</span> <span class="keyword">each</span> <span class="type">row</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">insert</span> <span class="keyword">into</span> user_logs(id, operation, operate_time, operate_id, operate_params) <span class="keyword">VALUES</span></span><br><span class="line">    (<span class="keyword">null</span>, <span class="string">&#x27;delete&#x27;</span>, now(), old.id, concat(<span class="string">&#x27;删除之前的数据: id=&#x27;</span>,old.id,<span class="string">&#x27;,name=&#x27;</span>,old.name, <span class="string">&#x27;, phone=&#x27;</span>, old.phone, <span class="string">&#x27;, email=&#x27;</span>, old.email, <span class="string">&#x27;, profession=&#x27;</span>, old.profession));</span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<p>测试触发器：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查看</span></span><br><span class="line"><span class="keyword">show</span> triggers ;</span><br><span class="line"><span class="comment">-- 插入数据到tb_user</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tb_user(id, name, phone, email, profession, age, gender, status, createtime) </span><br><span class="line"><span class="keyword">VALUES</span> (<span class="number">26</span>,<span class="string">&#x27;三皇子&#x27;</span>,<span class="string">&#x27;18809091212&#x27;</span>,<span class="string">&#x27;erhuangzi@163.com&#x27;</span>,<span class="string">&#x27;软件工程&#x27;</span>,<span class="number">23</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,now());</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 更新</span></span><br><span class="line">update tb_user <span class="keyword">set</span> profession <span class="operator">=</span> <span class="string">&#x27;会计&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">23</span>;</span><br><span class="line">update tb_user <span class="keyword">set</span> profession <span class="operator">=</span> <span class="string">&#x27;会计&#x27;</span> <span class="keyword">where</span> id <span class="operator">&lt;=</span> <span class="number">5</span>;  <span class="comment">-- 一次更新n数据，触发器也会触发n次</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 删除数据</span></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> tb_user <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">26</span>;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>假设触发器触发每次执行1s，insert table 500条数据，那么就需要触发500次触发器，光是触发器执行的时间就花费了500s，而insert 500条数据一共是1s，那么这个insert的效率就非常低了。因此我们特别需要注意的一点是触发器的begin end;之间的语句的执行效率一定要高，资源消耗要小。</p>
<p>触发器尽量少的使用，因为不管如何，它还是很消耗资源，如果使用的话要谨慎的使用，确定它是非常高效的：触发器是针对每一行的；对增删改非常频繁的表上切记不要使用触发器，因为它会非常消耗资源。</p>
</blockquote>
<h3 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h3><p>锁是计算机协调多个进程或线程并发访问某一资源的机制。在数据库中，除传统的计算资源（CPU、RAM、I/O）的争用以外，数据也是一种供许多用户共享的资源。如何保证数据并发访问的一致性、有效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。从这个角度来说，锁对数据库而言显得尤其重要，也更加复杂。</p>
<p>MySQL中的锁，按照锁的粒度分，分为以下三类：</p>
<ul>
<li>全局锁：锁定数据库中的所有表。</li>
<li>表级锁：每次操作锁住整张表。</li>
<li>行级锁：每次操作锁住对应的行数据。</li>
</ul>
<h4 id="全局锁"><a href="#全局锁" class="headerlink" title="全局锁"></a>全局锁</h4><p>全局锁就是对整个数据库实例加锁，加锁后整个实例就处于只读状态，后续的DML的写语句，DDL语句，已经更新操作的事务提交语句都将被阻塞。</p>
<p>其典型的使用场景是做全库的逻辑备份，对所有的表进行锁定，从而获取一致性视图，保证数据的完整性。</p>
<p>为什么全库逻辑备份，就需要加全就锁呢？</p>
<p><strong>A. 我们一起先来分析一下不加全局锁，可能存在的问题</strong></p>
<p>假设在数据库中存在这样三张表: tb_stock 库存表，tb_order 订单表，tb_orderlog 订单日志表。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117130611111.png" style="zoom:67%;" /></p>
<ol>
<li>在进行数据备份时，先备份了tb_stock库存表。</li>
<li>然后接下来，在业务系统中，执行了下单操作，扣减库存，生成订单（更新tb_stock表，插入tb_order表）。</li>
<li>然后再执行备份 tb_order表的逻辑。</li>
<li>业务中执行插入订单日志操作。</li>
<li>最后，又备份了tb_orderlog表。</li>
</ol>
<p>此时备份出来的数据，是存在问题的。因为备份出来的数据，tb_stock表与tb_order表的数据不一致(有最新操作的订单信息,但是库存数没减)。</p>
<p>那如何来规避这种问题呢? 此时就可以借助于MySQL的全局锁来解决。</p>
<p><strong>B. 再来分析一下加了全局锁后的情况</strong></p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117130711111.png" style="zoom:67%;" /></p>
<p>对数据库进行进行逻辑备份之前，先对整个数据库加上全局锁，一旦加了全局锁之后，其他的DDL、DML全部都处于阻塞状态，但是可以执行DQL语句，也就是处于只读状态，而数据备份就是查询操作。那么数据在进行逻辑备份的过程中，数据库中的数据就是不会发生变化的，这样就保证了数据的一致性和完整性。</p>
<p><strong>使用语法</strong></p>
<p>1）加全局锁</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flush tables <span class="keyword">with</span> read lock;</span><br></pre></td></tr></table></figure>
<p>2）数据备份</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot –p1234 itcast &gt; itcast.sql</span><br></pre></td></tr></table></figure>
<p>3）释放锁</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unlock tables;</span><br></pre></td></tr></table></figure>
<p>数据库中加全局锁，是一个比较重的操作，存在以下问题：</p>
<ol>
<li>如果在主库上备份，那么在备份期间都不能执行更新，业务基本上就得停摆。</li>
<li>如果在从库上备份，那么在备份期间从库不能执行主库同步过来的二进制日志（binlog），会导致主从延迟。</li>
</ol>
<p>在InnoDB引擎中，我们可以在备份时加上参数 <code>--single-transaction</code> 参数来完成不加锁的一致性数据备份。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump --single-transaction -uroot –p123456 itcast &gt; itcast.sql</span><br></pre></td></tr></table></figure>
<h4 id="表级锁"><a href="#表级锁" class="headerlink" title="表级锁"></a>表级锁</h4><p>表级锁，每次操作锁住整张表。锁定粒度大，发生锁冲突的概率最高，并发度最低。应用在MyISAM、InnoDB、BDB等存储引擎中</p>
<p>对于表级锁，主要分为以下三类：</p>
<ul>
<li>表锁</li>
<li>元数据锁（meta data lock，MDL）</li>
<li>意向锁</li>
</ul>
<h5 id="表锁"><a href="#表锁" class="headerlink" title="表锁"></a>表锁</h5><p>对于表锁，分为两类：</p>
<ul>
<li>表共享读锁（read lock）</li>
<li>表独占写锁（write lock）</li>
</ul>
<p>语法：</p>
<ul>
<li>加锁：<code>lock tables 表名... read/write</code></li>
<li>释放锁：<code>unlock tables</code> 或 客户端断开连接 </li>
</ul>
<p>特点：</p>
<p><strong>A. 读锁</strong></p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117130811111.png" alt=""></p>
<p>左侧为客户端一，对指定表加了读锁，不会影响右侧客户端二的读，但是会阻塞右侧客户端的写。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117130911111.png" style="zoom: 67%;" /></p>
<p><strong>B. 写锁</strong></p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117131011111.png" alt=""></p>
<p>左侧为客户端一，对指定表加了写锁，会阻塞右侧客户端的读和写。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117131211111.png" style="zoom: 67%;" /></p>
<blockquote>
<p>结论: 读锁不会阻塞其他客户端的读，但是会阻塞写。写锁既会阻塞其他客户端的读，又会阻塞其他客户端的写。</p>
</blockquote>
<h5 id="元数据锁"><a href="#元数据锁" class="headerlink" title="元数据锁"></a>元数据锁</h5><p>meta data lock , 元数据锁，简写MDL。</p>
<p>MDL加锁过程是系统自动控制，无需显式使用，在访问一张表的时候会自动加上。MDL锁主要作用是维护表元数据的数据一致性，在表上有活动事务的时候，不可以对元数据进行写入操作。为了避免DML与DDL冲突，保证读写的正确性。</p>
<p>这里的元数据，大家可以简单理解为就是一张表的表结构。 也就是说，某一张表涉及到未提交的事务时，是不能够修改这张表的表结构的。</p>
<p>在MySQL5.5中引入了MDL，当对一张表进行增删改查的时候，加MDL读锁(共享)；当对表结构进行变更操作的时候，加MDL写锁(排他)。</p>
<p>常见的SQL操作时，所添加的元数据锁：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>对应SQL</th>
<th>锁类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>lock tables xxx read / write</td>
<td>SHARED_READ_ONLY / SHARED_NO_READ_WRITE</td>
<td></td>
</tr>
<tr>
<td>select 、select … lock in share mode</td>
<td>SHARED_READ</td>
<td>与SHARED_READ、SHARED_WRITE兼容，与EXCLUSIVE互斥</td>
</tr>
<tr>
<td>insert 、update、delete、select … for update</td>
<td>SHARED_WRITE</td>
<td>与SHARED_READ、SHARED_WRITE兼容，与EXCLUSIVE互斥</td>
</tr>
<tr>
<td>alter table …</td>
<td>EXCLUSIVE</td>
<td>与其他的MDL都互斥</td>
</tr>
</tbody>
</table>
</div>
<p><strong>演示</strong></p>
<p>当执行SELECT、INSERT、UPDATE、DELETE等语句时，添加的是元数据共享锁（SHARED_READ /SHARED_WRITE），之间是兼容的。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117131311111.png" style="zoom: 67%;" /></p>
<p>当执行SELECT语句时，添加的是元数据共享锁（SHARED_READ），会阻塞元数据排他锁（EXCLUSIVE），之间是互斥的。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117131411111.png" style="zoom:67%;" /></p>
<p>我们可以通过下面的SQL，来查看数据库中的元数据锁的情况：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> object_type,object_schema,object_name,lock_type,lock_duration <span class="keyword">from</span> performance_schema.metadata_locks;</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117131511111.png" alt="image-20221117131511111" style="zoom:67%;" /></p>
<h5 id="意向锁"><a href="#意向锁" class="headerlink" title="意向锁"></a>意向锁</h5><p>为了避免DML在执行时，加的行锁与表锁的冲突，在InnoDB中引入了意向锁，使得表锁不用检查每行数据是否加锁，使用意向锁来减少表锁的检查。</p>
<p>假如没有意向锁，客户端一对表加了行锁后，客户端二如何给表加表锁呢，来通过示意图简单分析一下：</p>
<p>首先客户端一，开启一个事务，然后执行DML操作，在执行DML语句时，会对涉及到的行加行锁。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117131611111.png" style="zoom:80%;" /></p>
<p>当客户端二，想对这张表加表锁时，会检查当前表是否有对应的行锁，如果没有，则添加表锁，此时就会从第一行数据，检查到最后一行数据，效率较低。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117131711111.png" style="zoom: 67%;" /></p>
<p>有了意向锁之后 :</p>
<p>客户端一，在执行DML操作时，会对涉及的行加行锁，同时也会对该表加上意向锁。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117131811111.png" style="zoom: 80%;" /></p>
<p>而其他客户端，在对这张表加表锁的时候，会根据该表上所加的意向锁来判定是否可以成功加表锁，而不用逐行判断行锁情况了。</p>
<p><strong>分类</strong></p>
<ul>
<li>意向共享锁(IS): 由语句<code>select ... lock in share mode</code>添加 。 与 表锁共享锁(read)兼容，与表锁排他锁(write)互斥。</li>
<li>意向排他锁(IX): 由<code>insert</code>、<code>update</code>、<code>delete</code>、<code>select...for update</code>添加 。与表锁共享锁(read)及排他锁(write)都互斥，意向锁之间不会互斥。</li>
</ul>
<blockquote>
<p>一旦事务提交了，意向共享锁、意向排他锁，都会自动释放。</p>
</blockquote>
<p>可以通过以下SQL，查看意向锁及行锁的加锁情况：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> object_schema,object_name,index_name,lock_type,lock_mode,lock_data <span class="keyword">from</span> performance_schema.data_locks;</span><br></pre></td></tr></table></figure>
<p><strong>演示：</strong></p>
<p>A. 意向共享锁与表读锁是兼容的</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117131911111.png" style="zoom: 67%;" /></p>
<p>B. 意向排他锁与表读锁、写锁都是互斥的</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117132011111.png" style="zoom:67%;" /></p>
<h4 id="行级锁"><a href="#行级锁" class="headerlink" title="行级锁"></a>行级锁</h4><p>行级锁，每次操作锁住对应的行数据。锁定粒度最小，发生锁冲突的概率最低，并发度最高。应用在InnoDB存储引擎中。</p>
<p>InnoDB的数据是基于索引组织的，行锁是通过对索引上的索引项加锁来实现的，而不是对记录加的锁。对于行级锁，主要分为以下三类：</p>
<ul>
<li><p>行锁（<code>Record Lock</code>）：锁定单个行记录的锁，防止其他事务对此行进行update和delete。在RC、RR隔离级别下都支持。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117132211111.png" style="zoom: 67%;" /></p>
</li>
<li><p>间隙锁（<code>Gap Lock</code>）：锁定索引记录间隙（不含该记录），确保索引记录间隙不变，防止其他事务在这个间隙进行insert，产生幻读。在RR隔离级别下都支持。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117132311111.png" style="zoom:67%;" /></p>
</li>
<li><p>临键锁（<code>Next-Key Lock</code>）：行锁和间隙锁组合，同时锁住数据，并锁住数据前面的间隙Gap。在RR隔离级别下支持。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117132411111.png" style="zoom:67%;" /></p>
</li>
</ul>
<h5 id="行锁"><a href="#行锁" class="headerlink" title="行锁"></a>行锁</h5><p>InnoDB实现了以下两种类型的行锁：</p>
<ul>
<li>共享锁（S）：允许一个事务去读一行，阻止其他事务获得相同数据集的排它锁。</li>
<li>排他锁（X）：允许获取排他锁的事务更新数据，阻止其他事务获得相同数据集的共享锁和排他锁。</li>
</ul>
<p>共享锁与共享锁兼容，共享锁与排他锁、排他锁与排他锁冲突。</p>
<p>常见的SQL语句，在执行时，所加的行锁如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th><strong>SQL</strong></th>
<th><strong>行锁类型</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>INSERT …</td>
<td>排他锁</td>
<td>自动加锁</td>
</tr>
<tr>
<td>UPDATE …</td>
<td>排他锁</td>
<td>自动加锁</td>
</tr>
<tr>
<td>DELETE …</td>
<td>排他锁</td>
<td>自动加锁</td>
</tr>
<tr>
<td>SELECT（正常）</td>
<td>不加任何锁</td>
<td></td>
</tr>
<tr>
<td>SELECT … LOCK IN SHARE MODE</td>
<td>共享锁</td>
<td>需要手动在SELECT之后加<code>LOCK IN SHARE MODE</code></td>
</tr>
<tr>
<td>SELECT … FOR UPDATE</td>
<td>排他锁</td>
<td>需要手动在SELECT之后加<code>FOR UPDATE</code></td>
</tr>
</tbody>
</table>
</div>
<p>默认情况下，InnoDB在 REPEATABLE READ事务隔离级别运行，InnoDB使用 next-key 锁进行搜索和索引扫描，以防止幻读。</p>
<ul>
<li>针对唯一索引进行检索时，对已存在的记录进行等值匹配时，将会自动优化为行锁。</li>
<li>InnoDB的行锁是针对于索引加的锁，不通过索引条件检索数据，那么InnoDB将对表中的所有记录加锁，此时就会<strong>升级为表锁</strong></li>
</ul>
<p>可以通过以下SQL，查看意向锁及行锁的加锁情况：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> object_schema,object_name,index_name,lock_type,lock_mode,lock_data <span class="keyword">from</span> performance_schema.data_locks;</span><br></pre></td></tr></table></figure>
<p><strong>演示</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 数据准备</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `stu` (</span><br><span class="line">    `id` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> KEY AUTO_INCREMENT,</span><br><span class="line">    `name` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `age` <span class="type">int</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line">) ENGINE <span class="operator">=</span> InnoDB <span class="type">CHARACTER</span> <span class="keyword">SET</span> <span class="operator">=</span> utf8mb4;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `stu` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;tom&#x27;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `stu` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;cat&#x27;</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `stu` <span class="keyword">VALUES</span> (<span class="number">8</span>, <span class="string">&#x27;rose&#x27;</span>, <span class="number">8</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `stu` <span class="keyword">VALUES</span> (<span class="number">11</span>, <span class="string">&#x27;jetty&#x27;</span>, <span class="number">11</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `stu` <span class="keyword">VALUES</span> (<span class="number">19</span>, <span class="string">&#x27;lily&#x27;</span>, <span class="number">19</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `stu` <span class="keyword">VALUES</span> (<span class="number">25</span>, <span class="string">&#x27;luci&#x27;</span>, <span class="number">25</span>);</span><br></pre></td></tr></table></figure>
<p><strong>A. 普通的select语句，执行时，不会加锁。</strong></p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117132511111.png" style="zoom:67%;" /></p>
<p><strong>B. select…lock in share mode，加共享锁，共享锁与共享锁之间兼容。</strong></p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117132611111.png" style="zoom:67%;" /></p>
<p>共享锁与排他锁之间互斥</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117132711111.png" style="zoom:67%;" /></p>
<p>客户端一获取的是id为1这行的共享锁，客户端二是可以获取id为3这行的排它锁的，因为不是同一行数据。 而如果客户端二想获取id为1这行的排他锁，会处于阻塞状态，因为共享锁与排他锁之间互斥。</p>
<p><strong>C.  排它锁与排他锁之间互斥</strong></p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117132811111.png" style="zoom:67%;" /></p>
<p>当客户端一，执行update语句，会为id为1的记录加排他锁； 客户端二，如果也执行update语句更新id为1的数据，也要为id为1的数据加排他锁，但是客户端二会处于阻塞状态，因为排他锁之间是互斥的。 直到客户端一，把事务提交了，才会把这一行的行锁释放，此时客户端二，解除阻塞。</p>
<p><strong>D. 无索引行锁升级为表锁</strong></p>
<p>stu表中数据如下：</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117132911111.png" style="zoom:67%;" /></p>
<p>我们在两个客户端中执行如下操作：</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117133211111.png" style="zoom:67%;" /></p>
<p>在客户端一中，开启事务，并执行update语句，更新name为Lily的数据，也就是id为19的记录 。然后在客户端二中更新id为3的记录，却不能直接执行，会处于阻塞状态，为什么呢？</p>
<p>原因就是因为此时，客户端一，根据name字段进行更新时，name字段是没有索引的，如果没有索引，此时行锁会升级为表锁(因为行锁是对索引项加的锁，而name没有索引)。</p>
<p>接下来，我们再针对name字段建立索引，索引建立之后，再次做一个测试：</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117133311111.png" style="zoom:67%;" /></p>
<p>此时我们可以看到，客户端一，开启事务，然后依然是根据name进行更新。而客户端二，在更新id为3的数据时，更新成功，并未进入阻塞状态。 这样就说明，我们根据索引字段进行更新操作，就可以避免行锁升级为表锁的情况。</p>
<h5 id="间隙锁-amp-临键锁"><a href="#间隙锁-amp-临键锁" class="headerlink" title="间隙锁&amp;临键锁"></a>间隙锁&amp;临键锁</h5><p>默认情况下，InnoDB在 REPEATABLE READ事务隔离级别运行，InnoDB使用 next-key 锁进行搜索和索引扫描，以防止幻读。</p>
<ul>
<li>索引上的等值查询(唯一索引)，给不存在的记录加锁时, 优化为间隙锁 。</li>
<li>索引上的等值查询(非唯一普通索引)，向右遍历时最后一个值不满足查询需求时，next-key lock 退化为间隙锁。</li>
<li>索引上的范围查询(唯一索引)—会访问到不满足条件的第一个值为止。</li>
</ul>
<blockquote>
<p>注意：间隙锁唯一目的是防止其他事务插入间隙。间隙锁可以共存，一个事务采用的间隙锁不会阻止另一个事务在同一间隙上采用间隙锁。</p>
</blockquote>
<p><strong>示例演示</strong></p>
<p>A. 索引上的等值查询(唯一索引)，给不存在的记录加锁时, 优化为间隙锁。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117133411111.png" style="zoom:67%;" /></p>
<p>B. 索引上的等值查询(非唯一普通索引)，向右遍历时最后一个值不满足查询需求时，next-key lock 退化为间隙锁。</p>
<p>介绍分析一下：</p>
<p>我们知道InnoDB的B+树索引，叶子节点是有序的双向链表。 假如，我们要根据这个二级索引查询值为18的数据，并加上共享锁，我们是只锁定18这一行就可以了吗？ 并不是，因为是非唯一索引，这个结构中可能有多个18的存在，所以，在加锁时会继续往后找，找到一个不满足条件的值（当前案例中也就是29）。此时会对18加临键锁，并对29之前的间隙加锁。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117133511111.png" style="zoom: 80%;" /></p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117133611111.png" style="zoom: 67%;" /></p>
<p>C. 索引上的范围查询(唯一索引)—会访问到不满足条件的第一个值为止。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117133711111.png" style="zoom:67%;" /></p>
<p>查询的条件为id&gt;=19，并添加共享锁。 此时我们可以根据数据库表中现有的数据，将数据分为三个部分：[19]，(19,25]，(25,+∞]</p>
<p>所以数据库数据在加锁时，就是将19加了行锁，25的临键锁（包含25及25之前的间隙），正无穷的临键锁(正无穷及之前的间隙)</p>
<h3 id="InnoDB引擎"><a href="#InnoDB引擎" class="headerlink" title="InnoDB引擎"></a>InnoDB引擎</h3><h4 id="逻辑存储结构"><a href="#逻辑存储结构" class="headerlink" title="逻辑存储结构"></a>逻辑存储结构</h4><p>InnoDB的逻辑存储结构如下图所示：</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221109101611111.png" alt=""></p>
<p>1）表空间</p>
<p>表空间是InnoDB存储引擎逻辑结构的最高层， 如果用户启用了参数 <code>innodb_file_per_table</code>(在8.0版本中默认开启) ，则每张表都会有一个表空间（xxx.ibd），一个mysql实例可以对应多个表空间，用于存储记录、索引等数据。</p>
<p>2）段</p>
<p>段，分为数据段（Leaf node segment）、索引段（Non-leaf node segment）、回滚段（Rollback segment），InnoDB是索引组织表，数据段就是B+树的叶子节点， 索引段即为B+树的非叶子节点。段用来管理多个Extent（区）。</p>
<p>3）区</p>
<p>区，表空间的单元结构，每个区的大小为1M。 默认情况下， InnoDB存储引擎页大小为16K， 即一个区中一共有64个连续的页。</p>
<p>4）页</p>
<p>页，是InnoDB 存储引擎磁盘管理的最小单元，每个页的大小默认为 16KB。为了保证页的连续性，InnoDB 存储引擎每次从磁盘申请 4-5 个区。</p>
<p>5）行</p>
<p>行，InnoDB 存储引擎数据是按行进行存放的。在行中，默认有两个隐藏字段：</p>
<ul>
<li>Trx_id：每次对某条记录进行改动时，都会把对应的事务id赋值给trx_id隐藏列。</li>
<li>Roll_pointer：每次对某条引记录进行改动时，都会把旧的版本写入到undo日志中，然后这个隐藏列就相当于一个指针，可以通过它来找到该记录修改前的信息。</li>
</ul>
<h4 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h4><p>MySQL5.5 版本开始，默认使用InnoDB存储引擎，它擅长事务处理，具有崩溃恢复特性，在日常开发中使用非常广泛。下面是InnoDB架构图，<strong>左侧为内存结构，右侧为磁盘结构</strong>。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117133811111.png" alt=""></p>
<h5 id="内存结构"><a href="#内存结构" class="headerlink" title="内存结构"></a>内存结构</h5><p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117133911111.png" alt=""></p>
<p>在左侧的内存结构中，主要分为这么四大块儿： Buffer Pool、Change Buffer、Adaptive Hash Index、Log Buffer。 接下来介绍一下这四个部分。</p>
<p><strong>1）Buffer Pool</strong></p>
<p>InnoDB存储引擎基于磁盘文件存储，访问物理硬盘和在内存中进行访问，速度相差很大，为了尽可能弥补这两者之间的I/O效率的差值，就需要把经常使用的数据加载到缓冲池中，避免每次访问都进行磁盘I/O。</p>
<p>在InnoDB的缓冲池中不仅缓存了索引页和数据页，还包含了undo页、插入缓存、自适应哈希索引以及InnoDB的锁信息等等。</p>
<p>缓冲池 Buffer Pool，是主内存中的一个区域，里面可以缓存磁盘上经常操作的真实数据，在执行增删改查操作时，先操作缓冲池中的数据（若缓冲池没有数据，则从磁盘加载并缓存），然后再以一定频率刷新到磁盘，从而减少磁盘IO，加快处理速度。</p>
<p>缓冲池以Page页为单位，底层采用链表数据结构管理Page。根据状态，将Page分为三种类型：</p>
<ul>
<li>free page：空闲page，未被使用。</li>
<li>clean page：被使用page，数据没有被修改过。</li>
<li>dirty page：脏页，被使用page，数据被修改过，也中数据与磁盘的数据产生了不一致。</li>
</ul>
<p>在专用服务器上，通常将多达80％的物理内存分配给缓冲池 。参数设置： <code>show variables like &#39;innodb_buffer_pool_size&#39;;</code></p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117173511111.png" style="zoom:67%;" /></p>
<p><strong>2）Change Buffer</strong></p>
<p>Change Buffer，更改缓冲区（针对于非唯一二级索引页），在执行DML语句时，如果这些数据Page没有在Buffer Pool中，不会直接操作磁盘，而会将数据变更存在更改缓冲区 Change Buffer中，在未来数据被读取时，再将数据合并恢复到Buffer Pool中，再将合并后的数据刷新到磁盘中。</p>
<p>Change Buffer的意义是什么呢?</p>
<p>先来看一幅图，这个是二级索引的结构图：</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117173611111.png" alt=""></p>
<p>与聚集索引不同，二级索引通常是非唯一的，并且以相对随机的顺序插入二级索引。同样，删除和更新可能会影响索引树中不相邻的二级索引页，如果每一次都操作磁盘，会造成大量的磁盘IO。有了ChangeBuffer之后，我们可以在缓冲池中进行合并处理，减少磁盘IO。</p>
<p><strong>3）Adaptive Hash Index</strong></p>
<p>自适应hash索引，用于优化对Buffer Pool数据的查询。MySQL的innoDB引擎中虽然没有直接支持hash索引，但是给我们提供了一个功能就是这个自适应hash索引。因为前面我们讲到过，hash索引在进行等值匹配时，一般性能是要高于B+树的，因为hash索引一般只需要一次IO即可，而B+树，可能需要几次匹配，所以hash索引的效率要高，但是hash索引又不适合做范围查询、模糊匹配等。</p>
<p>InnoDB存储引擎会监控对表上各索引页的查询，如果观察到在特定的条件下hash索引可以提升速度，则建立hash索引，称之为自适应hash索引。</p>
<p>自适应哈希索引，无需人工干预，是系统根据情况自动完成。</p>
<p>参数： <code>adaptive_hash_index</code></p>
<p><strong>4）Log Buffer</strong></p>
<p>Log Buffer：日志缓冲区，用来保存要写入到磁盘中的log日志数据（redo log 、undo log），默认大小为 16MB，日志缓冲区的日志会定期刷新到磁盘中。如果需要更新、插入或删除许多行的事务，增加日志缓冲区的大小可以节省磁盘 I/O。</p>
<p><code>innodb_log_buffer_size</code>：缓冲区大小</p>
<p><code>innodb_flush_log_at_trx_commit</code>：日志刷新到磁盘时机，取值主要包含以下三个：</p>
<ul>
<li>1: 日志在每次事务提交时写入并刷新到磁盘，默认值。</li>
<li>0: 每秒将日志写入并刷新到磁盘一次。</li>
<li>2: 日志在每次事务提交后写入，并每秒刷新到磁盘一次。</li>
</ul>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117173711111.png" style="zoom: 67%;" /></p>
<h5 id="磁盘结构"><a href="#磁盘结构" class="headerlink" title="磁盘结构"></a>磁盘结构</h5><p>接下来，再来看看InnoDB体系结构的右边部分，也就是磁盘结构：</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117173811111.png" alt=""></p>
<p><strong>1）System Tablespace</strong></p>
<p>系统表空间是更改缓冲区的存储区域。如果表是在系统表空间而不是每个表文件或通用表空间中创建的，它也可能包含表和索引数据。(在MySQL5.x版本中还包含InnoDB数据字典、undolog等)</p>
<p>参数：<code>innodb_data_file_path</code></p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117173911111.png" style="zoom: 67%;" /></p>
<p>系统表空间，默认的文件名叫 <code>ibdata1</code>，可以在<code>/var/lib/mysql</code>看到该文件。</p>
<p><strong>2）File-Per-Table Tablespaces</strong></p>
<p>如果开启了innodb_file_per_table开关 ，则每个表的文件表空间包含单个InnoDB表的数据和索引 ，并存储在文件系统上的单个数据文件中。</p>
<p>开关参数：<code>innodb_file_per_table</code> ，该参数默认开启。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117203911111.png" style="zoom: 67%;" /></p>
<p>那也就是说，我们没创建一个表，都会产生一个表空间文件，如图：</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117204211111.png" style="zoom:67%;" /></p>
<p><strong>3）General Tablespaces</strong></p>
<p>通用表空间，需要通过 <code>CREATE TABLESPACE</code> 语法创建通用表空间，在创建表时，可以指定该表空间。</p>
<p>A. 创建表空间</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span>SPACE ts_name <span class="keyword">ADD</span> DATAFILE <span class="string">&#x27;file_name&#x27;</span> ENGINE <span class="operator">=</span> engine_name;</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117204311111.png" style="zoom: 67%;" /></p>
<p>B. 创建表时指定表空间</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> xxx ... TABLESPACE ts_name;</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117204411111.png" style="zoom:67%;" /></p>
<p><strong>4）Undo Tablespaces</strong></p>
<p>撤销表空间，MySQL实例在初始化时会自动创建两个默认的undo表空间（初始大小16M），用于存储undo log日志。</p>
<p><strong>5）Temporary Tablespaces</strong></p>
<p>InnoDB 使用会话临时表空间和全局临时表空间。存储用户创建的临时表等数据。</p>
<p><strong>6）Doublewrite Buffer Files</strong></p>
<p>双写缓冲区，innoDB引擎将数据页从Buffer Pool刷新到磁盘前，先将数据页写入双写缓冲区文件中，便于系统异常时恢复数据。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117204511111.png" alt=""></p>
<p><strong>7）Redo Log</strong></p>
<p>重做日志，是用来实现事务的持久性。该日志文件由两部分组成：重做日志缓冲（redo log buffer）以及重做日志文件（redo log）,前者是在内存中，后者在磁盘中。当事务提交之后会把所有修改信息都会存到该日志中, 用于在刷新脏页到磁盘时,发生错误时, 进行数据恢复使用。</p>
<p>以循环方式写入重做日志文件，涉及两个文件：</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117204611111.png" alt=""></p>
<p>前面我们介绍了InnoDB的内存结构，以及磁盘结构，那么内存中我们所更新的数据，又是如何到磁盘中的呢？ 此时，就涉及到一组后台线程，接下来，就来介绍一些InnoDB中涉及到的后台线程。</p>
<h5 id="后台线程"><a href="#后台线程" class="headerlink" title="后台线程"></a>后台线程</h5><p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117204711111.png" style="zoom:80%;" /></p>
<p>在InnoDB的后台线程中，分为4类，分别是：Master Thread 、IO Thread、Purge Thread、Page Cleaner Thread。</p>
<p><strong>1）Master Thread</strong></p>
<p>核心后台线程，负责调度其他线程，还负责将缓冲池中的数据异步刷新到磁盘中, 保持数据的一致性，还包括脏页的刷新、合并插入缓存、undo页的回收 。</p>
<p><strong>2）IO Thread</strong></p>
<p>在InnoDB存储引擎中大量使用了AIO来处理IO请求, 这样可以极大地提高数据库的性能，而IO Thread主要负责这些IO请求的回调。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>线程类型</th>
<th>默认个数</th>
<th>职责</th>
</tr>
</thead>
<tbody>
<tr>
<td>Read thread</td>
<td>4</td>
<td>负责读操作</td>
</tr>
<tr>
<td>Write thread</td>
<td>4</td>
<td>负责写操作</td>
</tr>
<tr>
<td>Log thread</td>
<td>1</td>
<td>负责将日志缓冲区刷新到磁盘</td>
</tr>
<tr>
<td>Insert buffer thread</td>
<td>1</td>
<td>负责将写缓冲区内容刷新到磁盘</td>
</tr>
</tbody>
</table>
</div>
<p>我们可以通过以下的这条指令，查看到InnoDB的状态信息，其中就包含IO Thread信息。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> engine innodb status \G;</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221117204811111.png" style="zoom: 67%;" /></p>
<p><strong>3）Purge Thread</strong></p>
<p>主要用于回收事务已经提交了的undo log，在事务提交之后，undo log可能不用了，就用它来回收。</p>
<p><strong>4）Page Cleaner Thread</strong></p>
<p>协助 Master Thread 刷新脏页到磁盘的线程，它可以减轻 Master Thread 的工作压力，减少阻塞。</p>
<h4 id="事务原理"><a href="#事务原理" class="headerlink" title="事务原理"></a>事务原理</h4><h5 id="事务基础"><a href="#事务基础" class="headerlink" title="事务基础"></a>事务基础</h5><p>事务 是一组操作的集合，它是一个不可分割的工作单位，事务会把所有的操作作为一个整体一起向系统提交或撤销操作请求，即这些操作要么同时成功，要么同时失败。</p>
<p>特性：</p>
<ul>
<li>原子性（Atomicity）：事务是不可分割的最小操作单元，要么全部成功，要么全部失败。</li>
<li>一致性（Consistency）：事务完成时，必须使所有的数据都保持一致状态。</li>
<li>隔离性（Isolation）：数据库系统提供的隔离机制，保证事务在不受外部并发操作影响的独立环境下运行。</li>
<li>持久性（Durability）：事务一旦提交或回滚，它对数据库中的数据的改变就是永久的。</li>
</ul>
<p>那实际上，我们研究事务的原理，就是研究MySQL的InnoDB引擎是如何保证事务的这四大特性的。</p>
<p>而对于这四大特性，实际上分为两个部分。 其中的原子性、一致性、持久化，实际上是由InnoDB中的两份日志来保证的，一份是redo log日志，一份是undo log日志。 而持久性是通过数据库的锁，加上MVCC来保证的。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118122311111.png" style="zoom:67%;" /></p>
<p>我们在讲解事务原理的时候，主要就是来研究一下<strong>redolog，undolog以及MVCC</strong>。</p>
<h5 id="redo-log"><a href="#redo-log" class="headerlink" title="redo log"></a>redo log</h5><p><strong>重做日志，记录的是事务提交时数据页的物理修改，是用来实现事务的持久性。</strong></p>
<p>该日志文件由两部分组成：重做日志缓冲（redo log buffer）以及重做日志文件（redo logfile）,前者是在内存中，后者在磁盘中。当事务提交之后会把所有修改信息都存到该日志文件中, 用于在刷新脏页到磁盘,发生错误时, 进行数据恢复使用。</p>
<p>如果没有redolog，可能会存在什么问题的？ 我们一起来分析一下。</p>
<p>我们知道，在InnoDB引擎中的内存结构中，主要的内存区域就是缓冲池，在缓冲池中缓存了很多的数据页。 当我们在一个事务中，执行多个增删改的操作时，InnoDB引擎会先操作缓冲池中的数据，如果缓冲区没有对应的数据，会通过后台线程将磁盘中的数据加载出来，存放在缓冲区中，然后将缓冲池中的数据修改，修改后的数据页我们称为脏页。 而脏页则会在一定的时机，通过后台线程刷新到磁盘中，从而保证缓冲区与磁盘的数据一致。 而缓冲区的脏页数据并不是实时刷新的，而是一段时间之后将缓冲区的数据刷新到磁盘中，假如刷新到磁盘的过程出错了，而提示给用户事务提交成功，而数据却没有持久化下来，这就出现问题了，没有保证事务的持久性。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118140511111.png" style="zoom: 67%;" /></p>
<p>那么，如何解决上述的问题呢？ 在InnoDB中提供了一份日志 redo log，接下来我们再来分析一下，通过redolog如何解决这个问题。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118140611111.png" style="zoom:67%;" /></p>
<p>有了redolog之后，当对缓冲区的数据进行增删改之后，会首先将操作的数据页的变化，记录在redo log buffer中。在事务提交时，会将redo log buffer中的数据刷新到redo log磁盘文件中。过一段时间之后，如果刷新缓冲区的脏页到磁盘时，发生错误，此时就可以借助于redo log进行数据恢复，这样就保证了事务的持久性。 而如果脏页成功刷新到磁盘 或 或者涉及到的数据已经落盘，此时redolog就没有作用了，就可以删除了，所以存在的两个redolog文件是循环写的。</p>
<p>那为什么每一次提交事务，要刷新redo log 到磁盘中呢，而不是直接将buffer pool中的脏页刷新到磁盘呢 ?</p>
<p>因为在业务操作中，我们操作数据一般都是随机读写磁盘的，而不是顺序读写磁盘。 而redo log在往磁盘文件中写入数据，由于是日志文件，所以都是顺序写的。顺序写的效率，要远大于随机写。 <strong>这种先写日志的方式，称之为 WAL（Write-Ahead Logging）</strong>。</p>
<h5 id="undo-log"><a href="#undo-log" class="headerlink" title="undo log"></a>undo log</h5><p>回滚日志，用于记录数据被修改前的信息 , 作用包含两个：<strong>提供回滚(保证事务的原子性)</strong> 和 <strong>MVCC(多版本并发控制)</strong> 。</p>
<p>undo log和redo log记录物理日志不一样，它是逻辑日志。可以认为当delete一条记录时，undo log中会记录一条对应的insert记录，反之亦然，当update一条记录时，它记录一条对应相反的update记录。当执行rollback时，就可以从undo log中的逻辑记录读取到相应的内容并进行回滚。</p>
<p>Undo log销毁：undo log在事务执行时产生，事务提交时，并不会立即删除undo log，因为这些日志可能还用于MVCC。</p>
<p>Undo log存储：undo log采用段的方式进行管理和记录，存放在前面介绍的 rollback segment回滚段中，内部包含1024个undo log segment。</p>
<h4 id="MVCC"><a href="#MVCC" class="headerlink" title="MVCC"></a>MVCC</h4><h5 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h5><p><strong>1）当前读</strong></p>
<p>读取的是记录的最新版本，读取时还要保证其他并发事务不能修改当前记录，会对读取的记录进行加锁。对于我们日常的操作，如：select … lock in share mode(共享锁)，select … for update、update、insert、delete(排他锁)都是一种当前读。</p>
<p>测试：</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118140711111.png" style="zoom:67%;" /></p>
<p>在测试中我们可以看到，即使是在默认的RR隔离级别下，事务A中依然可以读取到事务B最新提交的内容，因为在查询语句后面加上了 lock in share mode 共享锁，此时是当前读操作。当然，当我们加排他锁的时候，也是当前读操作。</p>
<p><strong>2）快照读</strong></p>
<p>简单的select（不加锁）就是快照读，快照读，读取的是记录数据的可见版本，有可能是历史数据，不加锁，是非阻塞读。</p>
<ul>
<li>Read Committed：每次select，都生成一个快照读。</li>
<li>Repeatable Read：开启事务后第一个select语句才是快照读的地方。</li>
<li>Serializable：快照读会退化为当前读。</li>
</ul>
<p>测试:</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118140811111.png" style="zoom:67%;" /></p>
<p>在测试中,我们看到即使事务B提交了数据,事务A中也查询不到。 原因就是因为普通的select是快照读，而在当前默认的RR隔离级别下，开启事务后第一个select语句才是快照读的地方，后面执行相同的select语句都是从快照中获取数据，可能不是当前的最新数据，这样也就保证了可重复读。</p>
<p><strong>3）MVCC</strong></p>
<p>全称 <code>Multi-Version Concurrency Control</code>，多版本并发控制。指维护一个数据的多个版本，使得读写操作没有冲突，快照读为MySQL实现MVCC提供了一个非阻塞读功能。MVCC的具体实现，还需要依赖于<strong>数据库记录中的三个隐式字段</strong>、<strong>undo log日志</strong>、<strong>readView</strong>。</p>
<p>接下来，我们再来介绍一下InnoDB引擎的表中涉及到的隐藏字段 、undolog 以及 readview，从而来介绍一下MVCC的原理。</p>
<h5 id="隐藏字段"><a href="#隐藏字段" class="headerlink" title="隐藏字段"></a>隐藏字段</h5><p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118140911111.png" alt=""></p>
<p>当我们创建了上面的这张表，我们在查看表结构的时候，就可以显式的看到这三个字段。 实际上除了这三个字段以外，InnoDB还会自动的给我们添加三个隐藏字段及其含义分别是：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>隐藏字段</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>DB_TRX_ID</td>
<td>最近修改事务ID，记录插入这条记录或最后一次修改该记录的事务ID。</td>
</tr>
<tr>
<td>DB_ROLL_PTR</td>
<td>回滚指针，指向这条记录的上一个版本，用于配合undo log，指向上一个版本。</td>
</tr>
<tr>
<td>DB_ROW_ID</td>
<td>隐藏主键，如果表结构没有指定主键，将会生成该隐藏字段。</td>
</tr>
</tbody>
</table>
</div>
<p>而上述的前两个字段是肯定会添加的，  是否添加最后一个字段<code>DB_ROW_ID</code>，得看当前表有没有主键， 如果有主键，则不会添加该隐藏字段。</p>
<p><strong>测试：</strong></p>
<p>1）查看有主键的表 stu</p>
<p>进入服务器中的 /var/lib/mysql/itcast/ , 查看stu的表结构信息, 通过指令：<code>ibd2sdi stu.ibd</code></p>
<p>查看到的表结构信息中，有一栏 columns，在其中我们会看到处理我们建表时指定的字段以外，还有额外的两个字段 分别是：DB_TRX_ID 、 DB_ROLL_PTR ，因为该表有主键，所以没有DB_ROW_ID隐藏字段。</p>
<table><tr>
<td><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118145011111.png" style="zoom:80%;" border=0></td>
<td><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118145211111.png" style="zoom:80%;" border=0></td>
</tr></table>

<p>2）查看没有主键的表 employee</p>
<p>建表语句：<code>create table employee (id int , name varchar(10));</code></p>
<p>此时，我们再通过以下指令来查看表结构及其其中的字段信息：<code>ibd2sdi employee.ibd</code></p>
<p>查看到的表结构信息中，有一栏 columns，在其中我们会看到处理我们建表时指定的字段以外，还有额外的三个字段 分别是：DB_TRX_ID 、 DB_ROLL_PTR 、DB_ROW_ID，因为employee表是没有指定主键的。</p>
<table><tr>
<td><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118145311111.png" style="zoom:80%;" border=0></td>
<td><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118145411111.png" style="zoom:80%;" border=0></td>
<td><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118145511111.png" style="zoom:80%;" border=0></td>
</tr></table>



<h5 id="undolog"><a href="#undolog" class="headerlink" title="undolog"></a>undolog</h5><p>回滚日志，在insert、update、delete的时候产生的便于数据回滚的日志。</p>
<p>当insert的时候，产生的undo log日志只在回滚时需要，在事务提交后，可被立即删除。</p>
<p>而update、delete的时候，产生的undo log日志不仅在回滚时需要，在快照读时也需要，不会立即被删除。</p>
<p><strong>版本链</strong></p>
<p>有一张表原始数据为：</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118145611111.png" style="zoom: 80%;" /></p>
<blockquote>
<p>DB_TRX_ID : 代表最近修改事务ID，记录插入这条记录或最后一次修改该记录的事务ID，是自增的。</p>
<p>DB_ROLL_PTR ： 由于这条数据是才插入的，没有被更新过，所以该字段值为null。</p>
</blockquote>
<p>然后，有四个并发事务同时在访问这张表。</p>
<p>A. 当事务2执行第一条修改语句时，会记录undo log日志，记录数据变更之前的样子; 然后更新记录，并且记录本次操作的事务ID，回滚指针，回滚指针用来指定如果发生回滚，回滚到哪一个版本。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118145711111.png" alt=""></p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118145811111.png" style="zoom: 67%;" /></p>
<p>B. 当事务3执行第一条修改语句时，也会记录undo log日志，记录数据变更之前的样子; 然后更新记录，并且记录本次操作的事务ID，回滚指针，回滚指针用来指定如果发生回滚，回滚到哪一个版本。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118145911111.png" style="zoom:80%;" /></p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118150411111.png" style="zoom:67%;" /></p>
<p>C. 当事务4执行第一条修改语句时，也会记录undo log日志，记录数据变更之前的样子; 然后更新记录，并且记录本次操作的事务ID，回滚指针，回滚指针用来指定如果发生回滚，回滚到哪一个版本。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118150511111.png" style="zoom:80%;" /></p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118150611111.png" style="zoom:67%;" /></p>
<blockquote>
<p>最终我们发现，不同事务或相同事务对同一条记录进行修改，会导致该记录的undolog生成一条记录版本链表，链表的头部是最新的旧记录，链表尾部是最早的旧记录。</p>
</blockquote>
<h5 id="readview"><a href="#readview" class="headerlink" title="readview"></a>readview</h5><p>ReadView（读视图）是 快照读 SQL执行时MVCC提取数据的依据，记录并维护系统当前活跃的事务（未提交的）id。</p>
<p>ReadView中包含了四个核心字段：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>字段</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>m_ids</td>
<td>当前活跃的事务ID集合</td>
</tr>
<tr>
<td>min_trx_id</td>
<td>最小活跃事务ID</td>
</tr>
<tr>
<td>max_trx_id</td>
<td>预分配事务ID，当前最大事务ID+1（因为事务ID是自增的）</td>
</tr>
<tr>
<td>creator_trx_id</td>
<td>ReadView创建者的事务ID</td>
</tr>
</tbody>
</table>
</div>
<p>而在readview中就规定了版本链数据的访问规则：</p>
<p><code>trx_id</code> 代表当前undolog版本链对应事务ID。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>条件</th>
<th>是否可以访问</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>trx_id == creator_trx_id</td>
<td>可以访问该版本</td>
<td>成立，说明数据是当前这个事务更改的。</td>
</tr>
<tr>
<td>trx_id &lt; min_trx_id</td>
<td>可以访问该版本</td>
<td>成立，说明数据已经提交了。</td>
</tr>
<tr>
<td>trx_id &gt; max_trx_id</td>
<td>不可以访问该版本</td>
<td>成立，说明该事务是在ReadView生成后才开启。</td>
</tr>
<tr>
<td>min_trx_id &lt;= trx_id &lt;= max_trx_id</td>
<td>如果trx_id不在m_ids中， 是可以访问该版本的</td>
<td>成立，说明数据已经提交。</td>
</tr>
</tbody>
</table>
</div>
<p>不同的隔离级别，生成ReadView的时机不同：</p>
<ul>
<li>READ COMMITTED ：在事务中每一次执行快照读时生成ReadView。</li>
<li>REPEATABLE READ：仅在事务中第一次执行快照读时生成ReadView，后续复用该ReadView。</li>
</ul>
<h5 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h5><p><strong>RC隔离级别</strong></p>
<p>RC隔离级别下，在事务中每一次执行快照读时生成ReadView。</p>
<p>我们就来分析事务5中，两次快照读读取数据，是如何获取数据的?</p>
<p>在事务5中，查询了两次id为30的记录，由于隔离级别为Read Committed，所以每一次进行快照读都会生成一个ReadView，那么两次生成的ReadView如下。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118150711111.png" style="zoom:80%;" /></p>
<p>那么这两次快照读在获取数据时，就需要根据所生成的ReadView以及ReadView的版本链访问规则，到undolog版本链中匹配数据，最终决定此次快照读返回的数据。</p>
<p>A. 先来看第一次快照读具体的读取过程：</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118150811111.png" style="zoom: 80%;" /></p>
<p>在进行匹配时，会从undo log的版本链，从上到下进行挨个匹配：</p>
<ul>
<li>先匹配<img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118150911111.png" alt="image-20221118150911111" style="zoom:67%;" />这条记录，这条记录对应的trx_id为4，也就是将4带入右侧的匹配规则中。 ①不满足 ②不满足 ③不满足 ④也不满足 ，都不满足，则继续匹配undo log版本链的下一条。</li>
<li>再匹配第二条<img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118151211111.png" style="zoom:80%;" />，这条记录对应的trx_id为3，也就是将3带入右侧的匹配规则中。①不满足 ②不满足 ③不满足 ④也不满足 ，都不满足，则继续匹配undo log版本链的下一条。</li>
<li>再匹配第三条<img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118151311111.png" style="zoom:80%;" />，这条记录对应的trx_id为2，也就是将2带入右侧的匹配规则中。①不满足 ②满足 终止匹配，此次快照读，返回的数据就是版本链中记录的这条数据。</li>
</ul>
<p>B. 再来看第二次快照读具体的读取过程：</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118151411111.png" style="zoom: 80%;" /></p>
<p>在进行匹配时，会从undo log的版本链，从上到下进行挨个匹配：</p>
<ul>
<li>先匹配<img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118150911111.png" alt="image-20221118150911111" style="zoom:67%;" />这条记录，这条记录对应的trx_id为4，也就是将4带入右侧的匹配规则中。 ①不满足 ②不满足 ③不满足 ④也不满足 ，都不满足，则继续匹配undo log版本链的下一条。</li>
<li>再匹配第二条<img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118151211111.png" style="zoom:80%;" />，这条记录对应的trx_id为3，也就是将3带入右侧的匹配规则中。①不满足 ②满足。终止匹配，此次快照读，返回的数据就是版本链中记录的这条数据。</li>
</ul>
<p><strong>RR隔离级别</strong></p>
<p>RR隔离级别下，仅在事务中第一次执行快照读时生成ReadView，后续复用该ReadView。 而RR 是可重复读，在一个事务中，执行两次相同的select语句，查询到的结果是一样的。</p>
<p>那MySQL是如何做到可重复读的呢? 我们简单分析一下就知道了</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118151511111.png" style="zoom:80%;" /></p>
<p>我们看到，在RR隔离级别下，只是在事务中第一次快照读时生成ReadView，后续都是复用该ReadView，那么既然ReadView都一样， ReadView的版本链匹配规则也一样， 那么最终快照读返回的结果也是一样的。</p>
<p>所以呢，MVCC的实现原理就是通过 InnoDB表的隐藏字段、UndoLog 版本链、ReadView来实现的。而MVCC + 锁，则实现了事务的隔离性。 而一致性则是由redolog 与 undolog保证。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118151611111.png" style="zoom:80%;" /></p>
<h3 id="MySQL管理"><a href="#MySQL管理" class="headerlink" title="MySQL管理"></a>MySQL管理</h3><h4 id="系统数据库"><a href="#系统数据库" class="headerlink" title="系统数据库"></a>系统数据库</h4><p>Mysql数据库安装完成后，自带了一下四个数据库，具体作用如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>数据库</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>mysql</td>
<td>存储MySQL服务器正常运行所需要的各种信息  （时区、主从、用户、权限等）</td>
</tr>
<tr>
<td>information_schema</td>
<td>提供了访问数据库元数据的各种表和视图，包含数据库、表、字段类型及访问权限等</td>
</tr>
<tr>
<td>performance_schema</td>
<td>为MySQL服务器运行时状态提供了一个底层监控功能，主要用于收集数据库服务器性能参数</td>
</tr>
<tr>
<td>sys</td>
<td>包含了一系列方便 DBA 和开发人员利用 performance_schema性能数据库进行性能调优和诊断的视图</td>
</tr>
</tbody>
</table>
</div>
<h4 id="常用工具"><a href="#常用工具" class="headerlink" title="常用工具"></a>常用工具</h4><h5 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h5><p>该mysql不是指mysql服务，而是指mysql的客户端工具。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">语法 ：</span><br><span class="line">	mysql [options] [database]</span><br><span class="line">选项 ：</span><br><span class="line">	<span class="operator">-</span>u, <span class="comment">--user=name #指定用户名</span></span><br><span class="line">	<span class="operator">-</span>p, <span class="comment">--password[=name] #指定密码</span></span><br><span class="line">	<span class="operator">-</span>h, <span class="comment">--host=name #指定服务器IP或域名</span></span><br><span class="line">	<span class="operator">-</span>P, <span class="comment">--port=port #指定连接端口</span></span><br><span class="line">	<span class="operator">-</span>e, <span class="comment">--execute=name #执行SQL语句并退出</span></span><br></pre></td></tr></table></figure>
<p>-e选项可以在Mysql客户端执行SQL语句，而不用连接到MySQL数据库再执行，对于一些批处理脚本，这种方式尤其方便。</p>
<p><strong>示例：</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql <span class="operator">-</span>uroot –p123456 db01 <span class="operator">-</span>e &quot;select * from stu&quot;;</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118151711111.png" style="zoom:67%;" /></p>
<h5 id="mysqladmin"><a href="#mysqladmin" class="headerlink" title="mysqladmin"></a>mysqladmin</h5><p>mysqladmin 是一个执行管理操作的客户端程序。可以用它来检查服务器的配置和当前状态、创建并删除数据库等。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin --<span class="built_in">help</span>		<span class="comment"># 过帮助文档查看选项</span></span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118151811111.png" style="zoom: 80%;" /></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">语法:</span><br><span class="line">	mysqladmin [options] command ...</span><br><span class="line">选项:</span><br><span class="line">    -u, --user=name #指定用户名</span><br><span class="line">    -p, --password[=name] #指定密码</span><br><span class="line">    -h, --host=name #指定服务器IP或域名</span><br><span class="line">    -P, --port=port #指定连接端口</span><br></pre></td></tr></table></figure>
<p><strong>示例：</strong></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -uroot –p1234 drop <span class="string">&#x27;test01&#x27;</span>;</span><br><span class="line">mysqladmin -uroot –p1234 version;</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118151911111.png" style="zoom: 67%;" /></p>
<h5 id="mysqlbinlog"><a href="#mysqlbinlog" class="headerlink" title="mysqlbinlog"></a>mysqlbinlog</h5><p>由于服务器生成的二进制日志文件以二进制格式保存，所以如果想要检查这些文本的文本格式，就会使用到 mysqlbinlog 日志管理工具。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">语法 ：</span><br><span class="line">	mysqlbinlog [options] log-files1 log-files2 ...</span><br><span class="line">选项 ：</span><br><span class="line">	-d, --database=name 指定数据库名称，只列出指定的数据库相关操作。</span><br><span class="line">	-o, --offset=# 忽略掉日志中的前n行命令。</span><br><span class="line">	-r,--result-file=name 将输出的文本格式日志输出到指定文件。</span><br><span class="line">	-s, --short-form 显示简单格式， 省略掉一些信息。</span><br><span class="line">	--start-datatime=date1 --stop-datetime=date2 指定日期间隔内的所有日志。</span><br><span class="line">	--start-position=pos1 --stop-position=pos2 指定位置间隔内的所有日志。</span><br></pre></td></tr></table></figure>
<p><strong>示例：</strong></p>
<p>查看 binlog.000008这个二进制文件中的数据信息</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118181011111.png" style="zoom: 67%;" /></p>
<p>上述查看到的二进制日志文件数据信息量太多了，不方便查询。 我们可以加上一个参数 -s 来显示简单格式。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118181211111.png" style="zoom:67%;" /></p>
<h5 id="mysqlshow"><a href="#mysqlshow" class="headerlink" title="mysqlshow"></a>mysqlshow</h5><p>mysqlshow 客户端对象查找工具，用来很快地查找存在哪些数据库、数据库中的表、表中的列或者索引。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">语法 ：</span><br><span class="line">	mysqlshow [options] [db_name [table_name [col_name]]]</span><br><span class="line">选项 ：</span><br><span class="line">	--count 显示数据库及表的统计信息（数据库，表 均可以不指定）</span><br><span class="line">	-i 显示指定数据库或者指定表的状态信息</span><br><span class="line">示例：</span><br><span class="line">	<span class="comment">#查询test库中每个表中的字段书，及行数</span></span><br><span class="line">	mysqlshow -uroot -p2143 <span class="built_in">test</span> --count</span><br><span class="line">	<span class="comment">#查询test库中book表的详细情况</span></span><br><span class="line">	mysqlshow -uroot -p2143 <span class="built_in">test</span> book --count</span><br></pre></td></tr></table></figure>
<p><strong>示例：</strong></p>
<p>A. 查询每个数据库的表的数量及表中记录的数量</p>
<p><code>mysqlshow -uroot -p1234 --count</code></p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118181311111.png" style="zoom: 80%;" /></p>
<p>B. 查看数据库db01的统计信息</p>
<p><code>mysqlshow -uroot -p1234 db01 --count</code></p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118181411111.png" style="zoom:80%;" /></p>
<p>C. 查看数据库db01中的course表的信息</p>
<p><code>mysqlshow -uroot -p1234 db01 course --count</code></p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118181511111.png" style="zoom:67%;" /></p>
<p>D. 查看数据库db01中的course表的id字段的信息</p>
<p><code>mysqlshow -uroot -p1234 db01 course id --count</code></p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118181611111.png" style="zoom:67%;" /></p>
<h5 id="mysqldump"><a href="#mysqldump" class="headerlink" title="mysqldump"></a>mysqldump</h5><p>mysqldump 客户端工具用来备份数据库或在不同数据库之间进行数据迁移。备份内容包含创建表，及插入表的SQL语句。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">语法 ：</span><br><span class="line">    mysqldump [options] db_name [tables]</span><br><span class="line">    mysqldump [options] --database/-B db1 [db2 db3...]</span><br><span class="line">    mysqldump [options] --all-databases/-A</span><br><span class="line">连接选项 ：</span><br><span class="line">    -u, --user=name 指定用户名</span><br><span class="line">    -p, --password[=name] 指定密码</span><br><span class="line">    -h, --host=name 指定服务器ip或域名</span><br><span class="line">    -P, --port=# 指定连接端口</span><br><span class="line">输出选项：</span><br><span class="line">    --add-drop-database 在每个数据库创建语句前加上 drop database 语句</span><br><span class="line">    --add-drop-table 在每个表创建语句前加上 drop table 语句 , 默认开启 ; 不开启 (--skip-add-drop-table)</span><br><span class="line">	-n, --no-create-db 不包含数据库的创建语句</span><br><span class="line">	-t, --no-create-info 不包含数据表的创建语句</span><br><span class="line">	-d --no-data 不包含数据</span><br><span class="line">	-T, --tab=name 自动生成两个文件：一个.sql文件，创建表结构的语句；一个.txt文件，数据文件</span><br></pre></td></tr></table></figure>
<p><strong>示例：</strong></p>
<p><strong>A. 备份db01数据库</strong></p>
<p><code>mysqldump -uroot -p1234 db01 &gt; db01.sql</code></p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118181711111.png" style="zoom:80%;" /></p>
<p>可以直接打开db01.sql，来查看备份出来的数据到底什么样。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118181811111.png" style="zoom:80%;" /></p>
<p>备份出来的数据包含：删除表的语句、创建表的语句、数据插入语句</p>
<p>如果我们在数据备份时，不需要创建表，或者不需要备份数据，只需要备份表结构，都可以通过对应的参数来实现。</p>
<p><strong>B. 备份db01数据库中的表数据，不备份表结构(-t)</strong></p>
<p><code>mysqldump -uroot -p1234 -t db01 &gt; db01.sql</code></p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118181911111.png" style="zoom: 67%;" /></p>
<p>打开 db02.sql ，来查看备份的数据，只有insert语句，没有备份表结构。</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118182011111.png" style="zoom:67%;" /></p>
<p><strong>C. 将db01数据库的表的表结构与数据分开备份(-T)</strong></p>
<p><code>mysqldump -uroot -p1234 -T /root db01 score</code></p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118182211111.png" alt=""></p>
<p>执行上述指令，会出错，数据不能完成备份，原因是因为我们所指定的数据存放目录<code>/root</code>，MySQL认为是不安全的，需要存储在MySQL信任的目录下。那么，哪个目录才是MySQL信任的目录呢，可以查看一下系统变量 <code>secure_file_priv</code> 。执行结果如下：</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118182311111.png" style="zoom:80%;" /></p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118182411111.png" style="zoom:80%;" /></p>
<p>上述的两个文件 score.sql 中记录的就是表结构文件，而 score.txt 就是表数据文件，但是需要注意表数据文件，并不是记录一条条的insert语句，而是按照一定的格式记录表结构中的数据。如下：</p>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118182511111.png" alt=""></p>
<h5 id="mysqlimport-source"><a href="#mysqlimport-source" class="headerlink" title="mysqlimport/source"></a>mysqlimport/source</h5><p>1）mysqlimport</p>
<p>mysqlimport 是客户端数据导入工具，用来导入mysqldump 加 -T 参数后导出的文本文件。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">语法 ：</span><br><span class="line">	mysqlimport [options] db_name textfile1 [textfile2...]</span><br><span class="line">示例 ：</span><br><span class="line">	mysqlimport -uroot -p2143 <span class="built_in">test</span> /tmp/city.txt</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/yanglinqi107/Images/raw/master/DB-img/image-20221118183311111.png" style="zoom:67%;" /></p>
<p>2）source</p>
<p>如果需要导入sql文件,可以使用mysql中的source 指令：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source <span class="operator">/</span>root<span class="operator">/</span>xxxxx.sql</span><br></pre></td></tr></table></figure>
<h4 id="数据库备份"><a href="#数据库备份" class="headerlink" title="数据库备份"></a>数据库备份</h4><ul>
<li>物理备份：复制数据库物理文件</li>
<li>逻辑备份：将数据库对象的定义和数据导出到指定文件</li>
<li>增量备份：只备份上次备份以来有变化的数据</li>
<li>完全备份：备份整个数据库</li>
</ul>
<p>MySQL保证数据安全的方法</p>
<ul>
<li>数据库备份：通过导出数据或者表文件的副本来保护数据</li>
<li>二进制日志文件：保存更新数据的所有语句</li>
<li>数据库复制：MySQL内部复制功能，建立在两个或两个以上服务器之间，通过设定主从关系来实现</li>
</ul>
<p><strong>SQL语句备份：导出表数据</strong></p>
<p>A. 导出到文本文件</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">SELECT...INTO...OUTFILE</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> table_name <span class="keyword">INTO</span> OUTFILE <span class="string">&#x27;FILENAME&#x27;</span></span><br><span class="line">[FIELDS</span><br><span class="line">    [TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;string&#x27;</span>]</span><br><span class="line">    [[OPTIONALLY]ENCLOSED <span class="keyword">BY</span> <span class="string">&#x27;char&#x27;</span>]</span><br><span class="line">    [ESCAPED <span class="keyword">BY</span> <span class="string">&#x27;char&#x27;</span>]</span><br><span class="line">]</span><br><span class="line">[LINES TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;string&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/*例*/</span></span><br><span class="line"><span class="keyword">select</span> employeeID,name,education</span><br><span class="line"><span class="keyword">from</span> employee</span><br><span class="line"><span class="keyword">into</span> outfile <span class="string">&#x27;D:/FileRecv/DB experiment/dataset2/employee2.csv&#x27;</span></span><br><span class="line">fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span></span><br><span class="line">lines terminated <span class="keyword">by</span> <span class="string">&#x27;\r\n&#x27;</span>;</span><br></pre></td></tr></table></figure>
<font color=#008000>  说明 </font>   

<p><code>fields terminated by &#39;string&#39;</code>: 指定字段值之间用某个string分隔，默认为’\t’</p>
<p><code>fields enclosed by &#39;char&#39;</code>: 指定包裹文件中字符值的符号，若使用optionally，则所有的值都放在指定符号之间，默认为空</p>
<p><code>fields escaped by &#39;char&#39;</code>: 指定转义字符，默认为\\</p>
<p><code>lines terminated by &#39;string&#39;</code>: 指定一行结束的标志，默认为 \n </p>
<p>B. 导入表数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">LOAD DATA INFILE <span class="string">&#x27;FILENAME&#x27;</span> [REPLACE<span class="operator">|</span>IGNORE] <span class="keyword">INTO</span> <span class="keyword">TABLE</span> table_name</span><br><span class="line">[FIELDS</span><br><span class="line">    [TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;string&#x27;</span>]</span><br><span class="line">    [[OPTIONALLY]ENCLOSED <span class="keyword">BY</span> <span class="string">&#x27;char&#x27;</span>]</span><br><span class="line">    [ESCAPED <span class="keyword">BY</span> <span class="string">&#x27;char&#x27;</span>]</span><br><span class="line">]</span><br><span class="line">[LINES [STARTING <span class="keyword">BY</span> <span class="string">&#x27;string&#x27;</span>] [TERMINATED <span class="keyword">BY</span> <span class="string">&#x27;string&#x27;</span>]]</span><br><span class="line">[IGNORE number LINES]</span><br><span class="line">[(列名或用户变量)]</span><br><span class="line">[<span class="keyword">SET</span> 列名<span class="operator">=</span>表达式]</span><br><span class="line"></span><br><span class="line"><span class="comment">/*例*/</span></span><br><span class="line"> load data</span><br><span class="line"> infile <span class="string">&#x27;D:/FileRecv/DB experiment/dataset2/salary2.csv&#x27;</span> ignore</span><br><span class="line"> <span class="keyword">into</span> <span class="keyword">table</span> salary</span><br><span class="line"> fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span></span><br><span class="line"> lines terminated <span class="keyword">by</span> <span class="string">&#x27;\r\n&#x27;</span>;</span><br></pre></td></tr></table></figure>
<font color=#008000>  说明 </font> 

<p><code>replace|ignore</code>: 指定replace，则当文件中出现与原有行相同的唯一关键字值时，输入行会替换原有行；指定ignore，则把与原有行有相同关键字值的输入行跳过</p>
<p><code>lines starting by &#39;string&#39;</code>: 指定一个前缀，导入数据行时，忽略行中该前缀和前缀之前的内容。如果某行不包括该前缀，则整个行被跳过。</p>
<p>例如：某文件中有 xxx ‘row’, 1，如果导入数据时指定starting by ‘xxx’，则最后得到数据 (‘row’, 1)</p>
<p><code>IGNORE number LINES</code>: 忽略文件前几行</p>
<p><strong>mysqldump备份和恢复</strong></p>
<p>恢复数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql[OPTIONS] db_name&lt;filename</span><br><span class="line"></span><br><span class="line">/*例，对应上例的备份*/</span><br><span class="line">mysql -uroot -p123456 DBST &lt; backup_DBST.sql</span><br></pre></td></tr></table></figure>
<p>恢复表数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*注：这方法对应的是上文SQL语句备份那里导出的文本文件*/</span></span><br><span class="line"><span class="comment">/*不推荐，限制太多，路径不能有空格、中文，文件名需和表名相同，文件必须是似乎必须是txt文件，字段需用\t分隔，行需用\r\n分隔有很多限制，会遇到各种错误*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*备份表的filename，恢复时需要完整路径*/</span></span><br><span class="line"><span class="comment">/*备份的.sql文件中是保存了表结构和表数据，即创建表和导入数据的sql语句和数据*/</span></span><br><span class="line"><span class="comment">/*使用这语句需要数据库中存在该表，若不存在，需要复制.sql文件中创建表的语句在mysql中创建表，当然也可以手敲*/</span></span><br><span class="line">mysqlimport [OPTIONS] db_name filename</span><br><span class="line"></span><br><span class="line">OPTIONS：</span><br><span class="line"><span class="comment">--d|--delete 在导入文件前清空表格</span></span><br><span class="line"><span class="comment">--replace|--ignore  关键字值相同时替换 | 忽略</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*例*/</span></span><br><span class="line">mysqlimport <span class="operator">-</span>uroot <span class="operator">-</span>p123456 <span class="comment">--replace dbst student.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*------------------------------------------------------------------*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*推荐，此方法对应的是mysqldump备份的.sql，简单，方便*/</span></span><br><span class="line"><span class="comment">/*除了在MySQL中直接使用MySQL语句之外，还可以在本地直接创建 filename.sql，再写入sql语句，在mysql中使用 source filename.sql执行文件中的sql语句*/</span></span><br><span class="line"><span class="comment">/*所以可以直接运行mysqldump备份的.sql文件*/</span></span><br><span class="line">mysql<span class="operator">&gt;</span> source filename.sql</span><br></pre></td></tr></table></figure>

    </div>

    
    
    
        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="fa fa-rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      
      
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="nav-number">1.</span> <span class="nav-text">触发器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%94%81"><span class="nav-number">2.</span> <span class="nav-text">锁</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E9%94%81"><span class="nav-number">2.1.</span> <span class="nav-text">全局锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A1%A8%E7%BA%A7%E9%94%81"><span class="nav-number">2.2.</span> <span class="nav-text">表级锁</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A1%A8%E9%94%81"><span class="nav-number">2.2.1.</span> <span class="nav-text">表锁</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%85%83%E6%95%B0%E6%8D%AE%E9%94%81"><span class="nav-number">2.2.2.</span> <span class="nav-text">元数据锁</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%84%8F%E5%90%91%E9%94%81"><span class="nav-number">2.2.3.</span> <span class="nav-text">意向锁</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A1%8C%E7%BA%A7%E9%94%81"><span class="nav-number">2.3.</span> <span class="nav-text">行级锁</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%A1%8C%E9%94%81"><span class="nav-number">2.3.1.</span> <span class="nav-text">行锁</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%97%B4%E9%9A%99%E9%94%81-amp-%E4%B8%B4%E9%94%AE%E9%94%81"><span class="nav-number">2.3.2.</span> <span class="nav-text">间隙锁&amp;临键锁</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#InnoDB%E5%BC%95%E6%93%8E"><span class="nav-number">3.</span> <span class="nav-text">InnoDB引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%80%BB%E8%BE%91%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84"><span class="nav-number">3.1.</span> <span class="nav-text">逻辑存储结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9E%B6%E6%9E%84"><span class="nav-number">3.2.</span> <span class="nav-text">架构</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84"><span class="nav-number">3.2.1.</span> <span class="nav-text">内存结构</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%A3%81%E7%9B%98%E7%BB%93%E6%9E%84"><span class="nav-number">3.2.2.</span> <span class="nav-text">磁盘结构</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%90%8E%E5%8F%B0%E7%BA%BF%E7%A8%8B"><span class="nav-number">3.2.3.</span> <span class="nav-text">后台线程</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E5%8E%9F%E7%90%86"><span class="nav-number">3.3.</span> <span class="nav-text">事务原理</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E5%9F%BA%E7%A1%80"><span class="nav-number">3.3.1.</span> <span class="nav-text">事务基础</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#redo-log"><span class="nav-number">3.3.2.</span> <span class="nav-text">redo log</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#undo-log"><span class="nav-number">3.3.3.</span> <span class="nav-text">undo log</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MVCC"><span class="nav-number">3.4.</span> <span class="nav-text">MVCC</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-number">3.4.1.</span> <span class="nav-text">基本概念</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%9A%90%E8%97%8F%E5%AD%97%E6%AE%B5"><span class="nav-number">3.4.2.</span> <span class="nav-text">隐藏字段</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#undolog"><span class="nav-number">3.4.3.</span> <span class="nav-text">undolog</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#readview"><span class="nav-number">3.4.4.</span> <span class="nav-text">readview</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="nav-number">3.4.5.</span> <span class="nav-text">原理分析</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL%E7%AE%A1%E7%90%86"><span class="nav-number">4.</span> <span class="nav-text">MySQL管理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">4.1.</span> <span class="nav-text">系统数据库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7"><span class="nav-number">4.2.</span> <span class="nav-text">常用工具</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#mysql"><span class="nav-number">4.2.1.</span> <span class="nav-text">mysql</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mysqladmin"><span class="nav-number">4.2.2.</span> <span class="nav-text">mysqladmin</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mysqlbinlog"><span class="nav-number">4.2.3.</span> <span class="nav-text">mysqlbinlog</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mysqlshow"><span class="nav-number">4.2.4.</span> <span class="nav-text">mysqlshow</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mysqldump"><span class="nav-number">4.2.5.</span> <span class="nav-text">mysqldump</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mysqlimport-source"><span class="nav-number">4.2.6.</span> <span class="nav-text">mysqlimport&#x2F;source</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD"><span class="nav-number">4.3.</span> <span class="nav-text">数据库备份</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yanglinqi"
      src="/images/headpic.jpg">
  <p class="site-author-name" itemprop="name">yanglinqi</p>
  <div class="site-description" itemprop="description">用于做笔记，对学过的知识总结</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">98</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">24</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/yanglinqi107" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;yanglinqi107" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yanglinqi</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.1.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/velocity-animate@1/velocity.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/velocity-animate@1/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  


  <script async src="/js/cursor/fireworks.js"></script>


</body>
</html>
